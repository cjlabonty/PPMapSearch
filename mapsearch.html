<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Map Search</title>

  <!-- Load Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <!-- Color gradient -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>


  <!--  STYLES  -->


  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    .tab-container {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      display: flex; justify-content: center; gap: 10px;
      padding: 0.5em;
      z-index: 999;
    }
    .tab {
      display: flex;
      cursor: pointer; padding: 3px 3px; border: 1px solid #6d6d6d; border-radius: 5px; font-size: 18px; width: 130px; height: 30px;
      align-items: center;
      justify-content: center;
      background-color: #ffffff;
      background-position: center;
      background-size: cover;
      color: rgb(0, 0, 0);
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.4);
    }
    .tab-portland {
      background-image: url("portland.jpg");
      color: white;
      background-position: 10% 20%;
      background-size: 130%;
      font-size: 22px;
      font-weight: bold;
      text-shadow: 1px 1px 3px rgba(2, 0, 121, 1);
    }
    .tab-south-portland {
      background-image: url("south-portland.jpg");
      color: white;
      background-position: 10% 40%;
      background-size: 140%;
      font-size: 17px;
      font-weight: bold;
      text-shadow: 1px 1px 3px rgb(255, 174, 0);
    }
    .tab-biddeford {
      background-image: url("biddeford.jpg");
      color: white;
      background-position: 80% 35%;
      background-size: 110%;
      font-size: 20px;
      font-weight: bold;
      text-shadow: 1px 1px 3px rgb(131, 6, 6);
    }
    .tab:hover {
      /* background: #e0e0e0; */
      opacity: 0.8;
    }
    .price-marker-wrapper {
      position: relative;
      display: inline-block;
    }
    .price-marker-icon .price-marker {
      overflow: hidden;
      white-space: nowrap;
      display: inline-block;
      justify-content: center;
      background-color: rgba(255, 255, 255, 0.9);
      padding: 2px 8px;
      border: 1px solid #666;
      /* box-shadow: 0 0 3px rgb(0, 255, 42); */
      border-radius: 999px;
      text-align: center;
      font-size: 14px;
      font-weight: bold;
      font-family:system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      position: relative;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      transform-origin: center center;
      transition: box-shadow 0.2s ease, transform 0.2s ease;
    }
    .price-marker-icon:hover .price-marker {
      /* box-shadow: 0 0 8px rgba(0,0,0,0.5); */
      transform: translate(-50%, -50%) scale(1.1);
      transform-origin: center center;
      z-index: 999999;
    }
    .page-layout {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 5px;
      gap: 0px;
    }
    .hover-popup {
      width: 200px;
      height: auto;
      object-fit: cover;
      border-radius: 3px;
      display: block;
      margin-bottom: 6px;
      text-align: center;
      font-size: medium;
      text-wrap: wrap;
      z-index: 999999;
    }
    .leaflet-tooltip.hover-popup img {
      width: 100px;
      height: 200px;
      object-fit: cover;
      border-radius: 3px;
      display: block;
      margin-bottom: 6px;
    }
    .count-icon {
      position: absolute;
      top: -4px;
      right: 4px;
      background-color: rgba(255, 255, 255, 0.95);
      color: black;
      font-size: 9px;
      padding: 2px 6px;
      border: 1px solid #000000;
      border-radius: 999px;
      font-weight: bold;
      box-shadow: 0 0 3px #04344b;
      /* transform: translate(-50%, -50%); */
      transform-origin: center center;
      /* transition: box-shadow 0.2s ease, transform 0.2s ease; */
    }
    .price-marker-icon .count-icon {
      top: 7px;
      right: -20px;
    }
    .price-marker-icon:hover .count-icon {
      transform: scale(1.1);
      transform-origin: center center;
      z-index: 999999;
    }
    .pplogo {
      position: absolute;
      top: 0;
      right: 0;
      z-index: 99999;
      transform: scale(0.5);
      transform-origin: top right;
      /* backdrop-filter: blur(9px);
      -webkit-backdrop-filter: blur(6px); */
      opacity: 0.8;
      filter: drop-shadow(0 2px 2px rgb(255, 255, 255));
    }
    .ripple {
      position: absolute;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.2);
      transform: scale(0);
      animation: ripple-animation 0.3s linear;
      pointer-events: none;
      z-index: 99999;
    }
    @keyframes ripple-animation {
      to {
        transform: scale(4);
        opacity: 0;
      }
    }
    #map {
      height: 100vh;
      width: 100%;
      margin: 0 auto;
    }
  </style>
</head>


<!-- PAGE LAYOUT -->


<body>
  <div class="page-layout">
    <img src="filters.png" class="side-image" />
    <!-- Map container -->
    <div id="map">
      <img src="pplogo.jpg" class="pplogo" />
      <!-- Tabs -->
      <div class="tab-container">
        <div class="tab tab-portland" data-lat="43.6557" data-lng="-70.2671" data-zoom="14">Portland</div>
        <div class="tab tab-south-portland" data-lat="43.6320" data-lng="-70.2674" data-zoom="14">South Portland</div>
        <div class="tab tab-biddeford" data-lat="43.4920" data-lng="-70.4534" data-zoom="14">Biddeford</div>
        <!-- <div class="tab" data-lat="34.2070" data-lng="-77.8865" data-zoom="13">Wilmington</div> -->
      </div>
    </div>
    <img src="units.png" class="side-image" />

  <!-- Load Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-ajax"></script>
  <script>
    document.addEventListener("DOMContentLoaded", async function () {


      /* MAP SETTINGS */


      // Create map and zoom into Portland
      const map = L.map("map").setView([43.6557, -70.2671], 14);

      // Map style
      const Jawg_Streets = L.tileLayer('https://tile.jawg.io/jawg-streets/{z}/{x}/{y}{r}.png?access-token=alJqGJgQQ9qhjVtAQcZPm3AUgLFazwU8RKOGWv2CmVUU3xpK8IgvVB94W1zUhMQX', {
        attribution: '<a href="https://jawg.io" title="Tiles Courtesy of Jawg Maps" target="_blank">&copy; <b>Jawg</b>Maps</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        minZoom: 10,
        maxZoom: 19,
      }).addTo(map);
      const esriSat = L.tileLayer(
        'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
          attribution: 'Tiles © Esri',
          minZoom: 10,
          maxZoom: 19,
        }
      );
      const esriRef = L.tileLayer(
        'https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}',
        { maxZoom: 19, attribution: 'Labels © Esri' }
      );
      const osmLabels = L.tileLayer(
        'https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png',
        { maxZoom: 19, attribution: '© OpenStreetMap contributors' }
      );
      fetch('portlandjson.json')
      .then(res => res.json())
      .then(geojson => {
        const boundaryLayer = L.geoJSON(geojson, {
          style: {
            color: 'blue',
            opacity: 0.3,
            weight: 2,
            fillOpacity: 0.05
          }
        }).addTo(map);
        map.fitBounds(boundaryLayer.getBounds());
      });


      /* ICONS */


      // Custom armature icon
      const armatureIcon = L.icon({
        iconUrl: 'https://www.portproperty.com/uploads/armature-clipart-2.png',
        iconSize: [100, 100],
        iconAnchor: [50, 50],
        popupAnchor: [0, -50],
        shadowSize:   [50, 64]
      });

      // Custom linden icon
      const lindenIcon = L.icon({
        iconUrl: 'thelinden.png',
        iconSize: [60, 60],
        iconAnchor: [30, 30],
        popupAnchor: [0, -45],
        shadowSize:   [30, 42]
      });

      // Normal icon
      const customIcon = L.icon({
        // iconUrl: 'https://www.portproperty.com/uploads/home-marker.png',
        iconUrl: 'map_pin.png',
        // iconUrl: 'house.png',
        iconSize: [50, 50],
        iconAnchor: [25, 50],
        popupAnchor: [0, -45],
      });

      const iconMarkers = L.layerGroup(); // for zoomed out icon marker
      const priceMarkers = L.layerGroup().addTo(map); // for zoomed in price marker


      /* FETCH ENDPOINT */


      const response = await fetch('https://www.portproperty.com/wp-json/property/v1/available', { cache: "no-store" });
      const data = await response.json();
      const allProperties = data.properties
      .map(item => ({
        image: item.image || '',
        title: item.title || '',
        address: item.location?.address,
        lat: parseFloat(item.location?.lat),
        lng: parseFloat(item.location?.lng),
        price: item.price !== null ? item.price : 'N/A',
        priceFormatted: item.price_formatted !== null ? item.price_formatted : 'N/A',
        building: item.building,
        availability: item.availability
      }));

      // Combine units where building has two different names
      allProperties.forEach(item => {
        switch(item.building) {
          case "28 Pearl St": // combine with 24 pearl street
          case "24 Pearl Street":
            item.building = "Riverdam"; break;
          case "132 Marginal Way - The Linden":
            item.building = "The Linden"; break;
          case "52 Hanover Street - The Armature":
            item.building = "The Armature"; break;
        }
      });

      let maxPrice = 0;
      let minPrice = 99999999;


      /* COMBINE UNITS */


      // Check if building has multiple units and combine them into one object
      const locMap = {};
      allProperties.forEach(p => {
        const key = p.building;
        // For first unit in building
        if(!locMap[key]) {
          locMap[key] = {
            lat: parseFloat(p.lat),
            lng: parseFloat(p.lng),
            count: 0,
            minPrice: Infinity,
            priceFormatted: p.priceFormatted,
            title: p.title,
            address: p.address,
            image: p.image,
            building: p.building,
            availability: p.availability
          };
        }
        const entry = locMap[key];
        entry.count += 1;
        const priceNum = parseFloat(p.price);

        // Calculate total min and max prices and min price per building
        if (!isNaN(priceNum)) {
          if(priceNum > maxPrice) { maxPrice = priceNum; }
          if(priceNum < minPrice) { minPrice = priceNum; }
          if(priceNum < entry.minPrice) {
            entry.minPrice = priceNum;
            entry.priceFormatted = p.priceFormatted;
          }
        }

        // If location is initially null, add after if other unit has it
        if (isNaN(entry.lat) && isNaN(entry.lng) && !isNaN(p.lat) && !isNaN(p.lng)) {
          entry.lat = p.lat;
          entry.lng = p.lng;
        }

        // Find earliest availability
        if(new Date(p.availability.date) < new Date(entry.availability.date)) {
          entry.availability = {
            date: p.availability.date,
            formatted: p.availability.formatted
          };
        }
        console.log(`${entry.building}: Lat: ${entry.lat} Lng: ${entry.lng}`);
      });

      const aggregated = Object.values(locMap);

      // In case one of the main buildings has no location
      aggregated.forEach(item => {
        if(isNaN(item.lat) || isNaN(item.lng)) {
          switch (item.building) {
            case "The Eddy":
              item.lat = 43.485531; item.lng = -70.486280; break;
            case "The Linden":
              item.lat = 43.663263; item.lng = -70.263645; break;
            case "Lofts on the Levee":
              item.lat = 43.496855; item.lng = -70.454992; break;
            case "The Armature":
              item.lat = 43.658970; item.lng = -70.264385; break;
            case "Riverdam":
              item.lat = 43.495347; item.lng = -70.453581; break;
          }
        }
      });


      /* MARKERS */


      // Color gradient for markers based on price
      const colorScale = d3.scaleLinear()
        .domain([minPrice, maxPrice])
        .range(["#1FFA07", "#006FFF"]);

      // Build all markers upfront
      async function buildMarkers() {
        iconMarkers.clearLayers();
        priceMarkers.clearLayers();

        // Loop through all buildings and create their markers
        for (let p of aggregated) {
          let lat = parseFloat(p.lat), lng = parseFloat(p.lng);
          if (isNaN(lat) || isNaN(lng)) continue;

          // Label for availability (REMOVE IF NOTHING IS CHANGED)
          const availabilityLabel = p.availability.formatted === "Available Now!"
            ? "Available Now!"
            : `${p.availability.formatted}`

          // Popup design (when hovering over price marker)
          const popupHtml = `
            <div style="max-width: 200px;">
              <img src="${p.image}" alt="${p.building}" style="width: 100%; border-radius: 8px; margin-bottom: 6px;" />
              <b>${p.building}</b><br>
              <span style="font-size: 15px; color: #333;">${availabilityLabel}</span><br>
            </div>
          `;


          /* ICON MARKER */


          // If building has custom icons
          let icon = customIcon;
          let zIndex = 0;
          if(p.address === "The Armature") {
            icon = armatureIcon;
            zIndex = 1000;
          } else if (p.address === "The Linden") {
            icon = lindenIcon;
            zIndex = 1000;
          }

          // Consider adding shadow. Likely need a svg
          const pinHtml = `<img src="map_pin.png" style="width: 50px; height: 50px; filter: drop-shadow(1px 2px 2px rgb(0, 0, 0));" />`;
          const normalIcon = makeIcon(pinHtml, p.count, [50,50]);

          L.marker([lat, lng], { 
            icon: normalIcon
          })
          .bindTooltip(popupHtml, {
            direction: 'top',
            offset: [0, -50],
            opacity: 0.95,
            className: 'hover-popup',
            permanent: false,
            sticky: false,
          })
          .addTo(iconMarkers);
          

          /* PRICE MARKER */

          
          const priceNum = parseFloat(p.minPrice);

          const label = priceNum === Infinity
            ? "$1800+"
            : p.count > 1
              ? `${p.priceFormatted}+`
              : `${p.priceFormatted}`;

          const shadowColor = priceNum === Infinity
            ? "orange"
            : colorScale(priceNum);

          const priceHtml = `
            <div class="price-marker"
                style="box-shadow: 0 0 3px ${shadowColor};">
              ${label}
            </div>
          `;
          const priceIcon = makeIcon(priceHtml, p.count, [50,50], 'price-marker-icon', true);

          const priceMarker = L.marker([lat,lng], { icon: priceIcon })
            .bindTooltip(popupHtml, {
              direction: 'top',
              offset: [0, -15],
              opacity: 0.95,
              className: 'hover-popup',
              permanent: false,
              sticky: false,
            })
            .addTo(priceMarkers);

          // Click function
          priceMarker.on('click', (e) => {
            // Ripple effect on click
            const el = e.target._icon.querySelector('.price-marker');
            const ripple = document.createElement('span');
            ripple.className = 'ripple';
            const rect = el.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            ripple.style.width = ripple.style.height = `${size}px`;
            const x = e.originalEvent.clientX - rect.left;
            const y = e.originalEvent.clientY - rect.top;
            ripple.style.left = `${x - size / 2}px`;
            ripple.style.top = `${y - size / 2}px`;
            el.appendChild(ripple);
            ripple.addEventListener('animationend', () => {
              ripple.remove();
            });
            // Other click functionality
          });
        }
      }
      await buildMarkers();


      /* ICON SETTINGS */


      // Build the icons with the badge for the unit count
      function makeIcon(innerHtml, count, size = [50,50], extraClass = '', anchorAtCenter = false) {
        const badgeHtml = count > 1
          ? `<span class="count-icon">${count}</span>`
          : ``;

        return L.divIcon({
          className: `custom-div-icon ${extraClass}`.trim(),
          html: `
            <div style="
                position: relative;
                width: ${size[0]}px;
                height: ${size[1]}px;
                overflow: visible;
              ">
              ${innerHtml}
              ${badgeHtml}
            </div>
          `,
          iconSize: size,
          iconAnchor: anchorAtCenter
            ? [size[0]/2, size[1]/2]
            : [size[0]/2, size[1]],
          popupAnchor: [0, -size[1]]
        });
      }


      /* ZOOM CONTROLS */


      // Change marker type based on zoom
      const changeMapThreshold = 16;
      let lastZoom = map.getZoom();
      map.on('zoomend', () => {
        const z = map.getZoom();
        if ((lastZoom < 14 && z >= 14) || (lastZoom >= 14 && z < 14)) {
          updateMarkers();
        }
        if (lastZoom < changeMapThreshold && z >= changeMapThreshold) {
          map.removeLayer(Jawg_Streets);
          map.addLayer(esriSat);
          map.addLayer(osmLabels);
        } else if (lastZoom >= changeMapThreshold && z < changeMapThreshold) {
          map.removeLayer(osmLabels);
          map.removeLayer(esriSat);
          map.addLayer(Jawg_Streets);
        }
        lastZoom = z;
      });

      // Change marker type
      function updateMarkers() {
        map.removeLayer(iconMarkers);
        map.removeLayer(priceMarkers);
        if (map.getZoom() < 14) {
          map.addLayer(iconMarkers);
        } else {
          map.addLayer(priceMarkers);
        }
      }
      updateMarkers();


      /* TAB SETTINGS */


      // Tab clicks
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const lat = parseFloat(tab.dataset.lat);
          const lng = parseFloat(tab.dataset.lng);
          const zoom = parseInt(tab.dataset.zoom);
          map.setView([lat, lng], zoom);
        });
      });
    });
  </script>
</body>
</html>